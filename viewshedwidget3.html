<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Interactive Viewshed Analysis</title>
<style>
       html, body, #sceneview {
           width: 100%;
           height: 100%;
           margin: 0;
           padding: 0;
       }
       #previewContainer {
           pointer-events: none;
           width: 200px;
           height: 125px;
           margin: 0;
           position: absolute;
           bottom: 25px;
           right: 10px;
           border: 1px solid dimgrey;
       }
       arcgis-scene {
           position: absolute;
           top: 0;
           left: 0;
           width: 100%;
           height: 100%;
       }
       #viewshedControls {
           position: absolute;
           width: 270px;
           right: var(--calcite-spacing-xxl);
           top: var(--calcite-spacing-xxl);
       }
       #viewshedList {
           margin-top: 10px;
       }
</style>
<script type="module" src="https://js.arcgis.com/calcite-components/3.0.3/calcite.esm.js"></script>
<link rel="stylesheet" href="https://js.arcgis.com/4.31/esri/themes/light/main.css" />
<script src="https://js.arcgis.com/4.31/"></script>
<script type="module" src="https://js.arcgis.com/map-components/4.31/arcgis-map-components.esm.js"></script>
</head>
<body>
<arcgis-scene id="sceneview" item-id="ea0dff6e8e3b442a9fe37560ee16f830">
<arcgis-zoom position="top-left"></arcgis-zoom>
<arcgis-navigation-toggle position="top-left"></arcgis-navigation-toggle>
<arcgis-compass position="top-left"></arcgis-compass>
</arcgis-scene>
<div id="previewContainer"></div>
<calcite-card id="viewshedControls">
<calcite-button id="createButton">Create Viewshed</calcite-button>
<calcite-button id="exportButton">Export Viewsheds</calcite-button>
<calcite-button id="importButton">Import Viewsheds</calcite-button>
<input type="file" id="fileInput" style="display:none"/>
<div id="viewshedList"></div>
</calcite-card>
<script>
       require([
           "esri/WebScene",
           "esri/views/SceneView",
           "esri/analysis/ViewshedAnalysis",
           "esri/analysis/Viewshed",
           "esri/geometry/SpatialReference",
           "esri/core/reactiveUtils",
           "esri/core/promiseUtils"
       ], (WebScene, SceneView, ViewshedAnalysis, Viewshed, SpatialReference, reactiveUtils, promiseUtils) => {
           const sceneElement = document.getElementById("sceneview");
           sceneElement.addEventListener("arcgisViewReadyChange", () => {
               const view = sceneElement.view;
               view.when(async () => {
                   const viewshedAnalysis = new ViewshedAnalysis();
                   view.analyses.add(viewshedAnalysis);
                   const viewshedList = document.getElementById("viewshedList");
                   document.getElementById("createButton").addEventListener("click", () => {
                       createViewshed();
                   });
                   document.getElementById("exportButton").addEventListener("click", exportViewsheds);
                   document.getElementById("importButton").addEventListener("click", importViewsheds);
                   function createViewshed() {
                       const lat = parseFloat(prompt("Enter Latitude:"));
                       const long = parseFloat(prompt("Enter Longitude:"));
                       const height = parseFloat(prompt("Enter Height:"));
                       const viewAngle = parseFloat(prompt("Enter View Angle (horizontal):"));
                       const distance = parseFloat(prompt("Enter Distance:"));
                       const newViewshed = new Viewshed({
                           observer: {
                               spatialReference: SpatialReference.WebMercator,
                               x: long,
                               y: lat,
                               z: height
                           },
                           farDistance: distance,
                           horizontalFieldOfView: viewAngle,
                           verticalFieldOfView: viewAngle // Assuming square view
                       });
                       viewshedAnalysis.viewsheds.add(newViewshed);
                       updateViewshedList();
                   }
                   function updateViewshedList() {
                       viewshedList.innerHTML = '';
                       viewshedAnalysis.viewsheds.forEach((vs, index) => {
                           const viewshedItem = document.createElement('div');
                           viewshedItem.textContent = `Viewshed ${index + 1} - Lat: ${vs.observer.y}, Long: ${vs.observer.x}`;
                           const removeButton = document.createElement('button');
                           removeButton.textContent = 'Remove';
                           removeButton.onclick = () => {
                               viewshedAnalysis.viewsheds.remove(vs);
                               updateViewshedList();
                           };
                           viewshedItem.appendChild(removeButton);
                           viewshedList.appendChild(viewshedItem);
                           // Make viewsheds draggable
                           viewshedItem.addEventListener('dblclick', () => {
                               const newLat = parseFloat(prompt("Enter new Latitude:", vs.observer.y));
                               const newLong = parseFloat(prompt("Enter new Longitude:", vs.observer.x));
                               const newHeight = parseFloat(prompt("Enter new Height:", vs.observer.z));
                               vs.observer.y = newLat;
                               vs.observer.x = newLong;
                               vs.observer.z = newHeight;
                               updateViewshedList();
                           });
                       });
                   }
                   function exportViewsheds() {
                       const viewsheds = viewshedAnalysis.viewsheds.map(vs => ({
                           lat: vs.observer.y,
                           long: vs.observer.x,
                           height: vs.observer.z,
                           horizontalFieldOfView: vs.horizontalFieldOfView,
                           verticalFieldOfView: vs.verticalFieldOfView,
                           farDistance: vs.farDistance
                       }));
                       const json = JSON.stringify(viewsheds);
                       console.log("Exported Viewsheds:", json);
                       alert("Viewsheds exported to console.");
                   }
                   function importViewsheds() {
                       const fileInput = document.getElementById("fileInput");
                       fileInput.click();
                       fileInput.onchange = (event) => {
                           const file = event.target.files[0];
                           const reader = new FileReader();
                           reader.onload = function(e) {
                               const viewsheds = JSON.parse(e.target.result);
                               viewsheds.forEach(vs => {
                                   const newViewshed = new Viewshed({
                                       observer: {
                                           spatialReference: SpatialReference.WebMercator,
                                           x: vs.long,
                                           y: vs.lat,
                                           z: vs.height
                                       },
                                       farDistance: vs.farDistance,
                                       horizontalFieldOfView: vs.horizontalFieldOfView,
                                       verticalFieldOfView: vs.verticalFieldOfView
                                   });
                                   viewshedAnalysis.viewsheds.add(newViewshed);
                               });
                               updateViewshedList();
                           };
                           reader.readAsText(file);
                       }
                   }
               });
           });
       });
</script>
</body>
</html>
