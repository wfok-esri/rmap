<!doctype html>
<html lang="en">
 <head>
   <meta charset="utf-8" />
   <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
   <title>Custom Viewshed Widget</title>
   <style>
     html,
     body {
       width: 100%;
       height: 100%;
       margin: 0;
       padding: 0;
     }

     #viewshedControls {
       position: absolute;
       top: 20px;
       right: 20px;
       width: 220px;
       z-index: 1;
     }

     #customViewshedControls {
       position: absolute;
       top: 120px;
       right: 20px;
       width: 220px;
       z-index: 1;
     }

     arcgis-layer-list {
       position: absolute;
       bottom: 20px;
       right: 20px;
       width: 220px;
       z-index: 1;
     }
   </style>

   <!-- Load Calcite components from CDN -->
   <script type="module" src="https://js.arcgis.com/calcite-components/3.0.3/calcite.esm.js"></script>

   <!-- Load the ArcGIS Maps SDK for JavaScript -->
   <link rel="stylesheet" href="https://js.arcgis.com/4.32/esri/themes/light/main.css" />
   <script src="https://js.arcgis.com/4.32/"></script>

   <!-- Load Map components from CDN-->
   <script type="module" src="https://js.arcgis.com/map-components/4.32/arcgis-map-components.esm.js"></script>
 </head>

 <body>
   <arcgis-scene id="sceneview" item-id="ea0dff6e8e3b442a9fe37560ee16f830">
     <arcgis-zoom position="top-left"></arcgis-zoom>
     <arcgis-navigation-toggle position="top-left"></arcgis-navigation-toggle>
     <arcgis-compass position="top-left"></arcgis-compass>
     <arcgis-placement position="bottom-right">
       <arcgis-layer-list></arcgis-layer-list>
     </arcgis-placement>
   </arcgis-scene>

   <calcite-card id="viewshedControls">
     <calcite-button id="createButton">Create Viewshed</calcite-button>
     <calcite-button id="cancelButton" style="display: none">Cancel</calcite-button>
     <calcite-button id="toggleModeButton">Switch to Manual Input</calcite-button>
     <div id="manualInputForm">
       <calcite-input id="latInput" placeholder="Latitude"></calcite-input>
       <calcite-input id="longInput" placeholder="Longitude"></calcite-input>
       <calcite-input id="heightInput" placeholder="Height"></calcite-input>
       <calcite-input id="angleInput" placeholder="View Angle"></calcite-input>
       <calcite-input id="distanceInput" placeholder="Distance"></calcite-input>
       <calcite-button id="addManualViewshed">Add Viewshed</calcite-button>
     </div>
     <calcite-button id="exportButton">Export Viewsheds</calcite-button>
     <calcite-button id="importButton">Import Viewsheds</calcite-button>
   </calcite-card>

   <calcite-card id="customViewshedControls">
     <calcite-label>Selected Viewshed Controls</calcite-label>
     <calcite-button id="renameButton">Rename</calcite-button>
     <calcite-button id="zoomToButton">Zoom To</calcite-button>
     <calcite-button id="removeButton">Remove</calcite-button>
   </calcite-card>

   <script>
     require([
       "esri/WebScene",
       "esri/Camera",
       "esri/views/SceneView",
       "esri/analysis/ViewshedAnalysis",
       "esri/analysis/Viewshed",
       "esri/geometry/SpatialReference",
       "esri/core/promiseUtils",
       "esri/core/reactiveUtils",
       "esri/Color",
       "esri/layers/ViewshedLayer"
     ], (
       WebScene,
       Camera,
       SceneView,
       ViewshedAnalysis,
       Viewshed,
       SpatialReference,
       promiseUtils,
       reactiveUtils,
       Color,
       ViewshedLayer
     ) => {
       const sceneElement = document.getElementById("sceneview");
       sceneElement.addEventListener("arcgisViewReadyChange", () => {
         const view = sceneElement.view;
         view.when(async () => {
           const viewshedAnalysis = new ViewshedAnalysis();
           view.analyses.add(viewshedAnalysis);

           // Create a ViewshedLayer to manage the viewsheds
           const viewshedLayer = new ViewshedLayer({
             title: "Viewsheds",
             source: viewshedAnalysis
           });
           view.map.add(viewshedLayer);

           let selectedViewshed = null;

           // Event listener for layer list selection
           const layerList = document.querySelector("arcgis-layer-list");
           layerList.addEventListener("arcgisLayerListChange", (event) => {
             const selectedLayer = event.detail.selectedItems[0];
             if (selectedLayer && selectedLayer.layer === viewshedLayer) {
               selectedViewshed = viewshedAnalysis.viewsheds.getItemAt(0); // Adjust as needed
             }
           });

           // Rename Button
           document.getElementById("renameButton").addEventListener("click", () => {
             if (selectedViewshed) {
               const newName = prompt("Enter a new name for the viewshed:");
               if (newName) {
                 selectedViewshed.title = newName;
               }
             }
           });

           // Zoom To Button
           document.getElementById("zoomToButton").addEventListener("click", () => {
             if (selectedViewshed) {
               const camera = new Camera({
                 position: {
                   spatialReference: SpatialReference.WebMercator,
                   x: selectedViewshed.observer.x,
                   y: selectedViewshed.observer.y,
                   z: selectedViewshed.observer.z + 1000 // Adjust height as needed
                 },
                 tilt: 0,
                 heading: 0
               });
               view.goTo(camera);
             }
           });

           // Remove Button
           document.getElementById("removeButton").addEventListener("click", () => {
             if (selectedViewshed) {
               viewshedAnalysis.viewsheds.remove(selectedViewshed);
               selectedViewshed = null;
             }
           });
         });
       });
     });
   </script>
 </body>
</html>
